/** @format */

import { Pipe, type PipeTransform } from "@angular/core";
import { PluralizePipe } from "projects/core";
import * as RelativeTime from "dayjs/plugin/relativeTime";
import * as dayjs from "dayjs";

dayjs.extend(RelativeTime);

/**
 * Пайп для вычисления и отображения возраста по дате рождения
 *
 * Назначение:
 * - Вычисляет точный возраст в годах на основе даты рождения
 * - Автоматически склоняет слово "год" в соответствии с русской грамматикой
 * - Возвращает читаемую строку с возрастом
 *
 * Особенности:
 * - Использует dayjs для точного вычисления разности в годах
 * - Учитывает високосные годы и точные даты
 * - Интегрируется с PluralizePipe для правильного склонения
 * - Округляет возраст до целых лет (Math.floor)
 *
 * Применение:
 * - Отображение возраста пользователей в профилях
 * - Показ возраста в списках участников
 * - Любые места где нужно показать возраст по дате рождения
 */
@Pipe({
  name: "yearsFromBirthday",
  standalone: true,
})
export class YearsFromBirthdayPipe implements PipeTransform {
  /**
   * Вычисляет возраст по дате рождения и возвращает отформатированную строку
   * @param value - Дата рождения в любом формате, поддерживаемом dayjs
   * @returns Строка с возрастом и правильно склоненным словом "год"
   *
   * Поддерживаемые форматы даты:
   * - ISO строки: "1990-03-15T00:00:00.000Z"
   * - Строки даты: "1990-03-15", "15.03.1990"
   * - Date объекты
   * - Timestamp числа
   *
   * Алгоритм:
   * 1. Парсит дату рождения с помощью dayjs
   * 2. Вычисляет точную разность в годах с текущей датой
   * 3. Округляет до целых лет (Math.floor)
   * 4. Использует PluralizePipe для склонения слова "год"
   * 5. Возвращает строку вида "25 лет", "1 год", "2 года"
   *
   * Примеры использования в шаблонах:
   *
   * <!-- В профиле пользователя -->
   * <div class="user-age">
   *   Возраст: {{ user.birthday | yearsFromBirthday }}
   * </div>
   *
   * <!-- В списке участников -->
   * <div *ngFor="let member of teamMembers">
   *   {{ member.name }}, {{ member.birthday | yearsFromBirthday }}
   * </div>
   *
   * <!-- В карточке пользователя -->
   * <span class="age-badge">{{ profile.dateOfBirth | yearsFromBirthday }}</span>
   *
   * Примеры результатов:
   * - Дата рождения: 15.03.2000 → "24 года" (если сейчас 2024)
   * - Дата рождения: 01.01.2023 → "1 год"
   * - Дата рождения: 10.05.1995 → "29 лет"
   * - Дата рождения: 20.12.2020 → "4 года"
   *
   * Точность вычислений:
   * - Учитывает точную дату (день и месяц)
   * - Если день рождения еще не наступил в этом году, возраст будет меньше на 1
   * - Использует Math.floor для округления вниз (не показывает неполные годы)
   */
  transform(value: string): string {
    // Вычисляем точную разность в годах между датой рождения и текущей датой
    // diff с параметром 'year' и true возвращает точное значение с дробной частью
    const years = Math.floor(dayjs().diff(dayjs(value), "year", true));

    // Создаем экземпляр PluralizePipe для склонения слова "год"
    const pluralize = new PluralizePipe();

    // Возвращаем отформатированную строку с возрастом и склоненным словом
    return `${years} ${pluralize.transform(years, ["год", "года", "лет"])}`;
  }
}
