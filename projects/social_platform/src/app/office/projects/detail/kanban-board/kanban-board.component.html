<!-- @format -->

<div class="kanban">
  <div class="kanban__wrapper" (clickOutside)="closeDetailTask()">
    @if (projectBoardInfo(); as projectBoardInfo) {
    <app-kanban-board-sidebar [projectBoardInfo]="projectBoardInfo"></app-kanban-board-sidebar>
    }
    <div
      class="kanban__column-wrapper"
      cdkDropList
      [cdkDropListData]="boardColumns()"
      [formGroup]="taskForm"
      cdkDropListOrientation="horizontal"
      (cdkDropListDropped)="onDropColumn($event)"
      [cdkDropListSortPredicate]="columnDropPredicate"
      [style.overflow-x]="boardColumns().length > 3 ? 'auto' : 'none'"
    >
      @for (boardColumn of boardColumns(); track $index) {
      <div
        class="kanban__column"
        cdkDrag
        [cdkDragDisabled]="boardColumn.locked || boardColumn.id === 0"
      >
        @if (selectedColumnId === boardColumn.id && editColumn) { @if (taskForm.get("columnTitle");
        as columnTitle) {
        <app-input
          class="kanban__column-input"
          formControlName="columnTitle"
          [error]="columnTitle | controlError"
          size="big"
          placeholder="название столбика"
          type="text"
          autofocus
          (keydown.escape)="cancelRenamColumn()"
          (keydown.enter)="confirmRenameColumn()"
        >
        </app-input>
        } } @else {
        <div class="kanban__column-header">
          <p class="text-body-12">{{ boardColumn.tasks.length }}</p>
          <div class="kanban__column-locked">
            @if (boardColumn.locked) {
            <i appIcon icon="lock" appSquare="8"></i>
            } @if (!(selectedColumnId === boardColumn.id && editColumn)) {
            <p class="text-body-12">{{ boardColumn.name }}</p>
            }
          </div>

          <div>
            <i appIcon icon="dots" appSquare="8" (click)="toggleDropDown(boardColumn.id)"></i>

            @if (isColumnInfoOpen && (selectedColumnId === boardColumn.id)) {
            <app-dropdown
              [isOpen]="isColumnInfoOpen"
              type="text"
              colorText="grey"
              (select)="onTypeSelect($event, false, boardColumn.id)"
              (outside)="isColumnInfoOpen = false"
              [options]="boardColumn.id === 0 ? columnInfoOptions.slice(0, 1) : columnInfoOptions"
            ></app-dropdown>
            }
          </div>
        </div>
        }

        <div
          class="kanban__tasks"
          cdkDropList
          [cdkDropListData]="boardColumn.tasks"
          [cdkDropListConnectedTo]="connectedLists()"
          [id]="'tasks-column-' + boardColumn.id"
          (cdkDropListDropped)="onDropTask($event)"
        >
          @for (task of boardColumn.tasks; track task.id) {
          <app-kanban-task
            cdkDrag
            (click)="openDetailTask(task.id)"
            [task]="task"
          ></app-kanban-task>
          } @if (addTaskClick) { @if (selectedColumnId === boardColumn.id) { @if
          (taskForm.get("taskTitle"); as taskTitle) {
          <div class="kanban__task">
            <app-input
              formControlName="taskTitle"
              size="big"
              placeholder="введите название задачи"
              type="text"
              autofocus
              (keydown.escape)="cancelAddingTask()"
              (keydown.enter)="confirmAddTask()"
            ></app-input>
          </div>
          } } }
        </div>

        <i
          class="kanban__column--add-task"
          (click)="startAddingTask(boardColumn.id)"
          appIcon
          icon="plus"
          appSquare="10"
        ></i>
      </div>
      }

      <div class="kanban__column">
        <div class="kanban__column-header kanban__column-header--empty" (click)="addColumn()">
          <i appIcon icon="plus" appSquare="10"></i>
        </div>
      </div>
    </div>

    @if (isTaskDetailOpen()) {
    <app-task-detail
      [goals]="projectBoardInfo()?.goals"
      [collaborators]="projectBoardInfo()?.collaborators"
      (delete)="onDeleteTask()"
    ></app-task-detail>
    }
  </div>
</div>
