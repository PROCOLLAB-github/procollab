<!-- @format -->
<div>
  <div class="project__top">
    <p class="project__title">Редактировать проект</p>
    <a class="project__back" [routerLink]="'/office/projects/' + profileId">
      <app-button [color]="'grey'" customTypographyClass="text-body-12">Назад</app-button>
    </a>
  </div>
  <main class="project">
    <form [formGroup]="projectForm" class="project__form">
      <nav class="project__navigation">
        <ul class="project__nav">
          @for (item of navItems; track $index) {
          <li class="project__item" (click)="navigateStep(item.step)">
            <img
              class="project__image"
              [class.project__image--active]="editingStep === item.step"
              alt="project-icon"
              [src]="item.src"
            />
            <p
              class="project__subtitle"
              [class.project__subtitle--active]="editingStep === item.step"
            >
              {{ item.label }}
            </p>
          </li>
          }
        </ul>
      </nav>

      <div class="project__inner">
        @if (editingStep === "main") {

        <div class="project__left">
          <div class="project__info">
            @if (projectForm.get("imageAddress"); as imagesAddress) {
            <div class="project__image">
              <app-avatar-control
                id="imageAddress"
                formControlName="imageAddress"
                [error]="(imagesAddress | controlError) && projSubmitInitiated"
              ></app-avatar-control>
              @if ((imagesAddress | controlError: "required") && projSubmitInitiated) {
              <div class="text-body-14 error">
                {{ errorMessage.EMPTY_AVATAR }}
              </div>
              }
            </div>
            }

            <div class="project__generals">
              @if (projectForm.get("name"); as name) {
              <fieldset>
                <label class="field-label" for="name">Название проекта</label>
                <app-input
                  id="name"
                  formControlName="name"
                  [error]="(name | controlError) && projSubmitInitiated"
                  placeholder="Название"
                ></app-input>
                @if ((name | controlError: "required") && projSubmitInitiated) {
                <div class="text-body-14 error">
                  {{ errorMessage.VALIDATION_REQUIRED }}
                </div>
                }
              </fieldset>
              } @if (projectForm.get("region"); as region) {
              <fieldset>
                <label class="field-label" for="region">Регион проекта</label>
                <app-input
                  id="region"
                  formControlName="region"
                  [error]="(region | controlError) && projSubmitInitiated"
                  placeholder="Введите регион"
                ></app-input>
                @if ((region | controlError: "required") && projSubmitInitiated) {
                <div class="text-body-14 error">
                  {{ errorMessage.VALIDATION_REQUIRED }}
                </div>
                }
              </fieldset>
              }
            </div>
          </div>

          <div class="project__additional">
            @if (projectForm.get("industryId"); as industry) {
            <fieldset>
              <label class="field-label" for="industry">Сфера проекта</label>
              @if (industries$ | async; as industries) {
              <app-select
                id="industry"
                formControlName="industryId"
                placeholder="Выберите сферу к которой относится ваш проект"
                [options]="industries"
              ></app-select>
              } @if (industry | controlError: "required") {
              <div class="text-body-14 error">
                {{ errorMessage.VALIDATION_REQUIRED }}
              </div>
              }
            </fieldset>
            } @if (projectForm.get("step"); as step) {
            <fieldset>
              <label class="field-label" for="step">Этап на котором находится проект</label>
              @if (projectSteps$ | async; as steps) {
              <app-select
                id="step"
                formControlName="step"
                placeholder="Выберите этап на котором находится ваш проект"
                [options]="steps"
              ></app-select>
              } @if (step | controlError: "required") {
              <div class="text-body-14 error">
                {{ errorMessage.VALIDATION_REQUIRED }}
              </div>
              }
            </fieldset>
            } @if (projectForm.get("description"); as description) {
            <fieldset>
              <label for="description" class="field-label">Информация о проекте</label>
              <app-textarea
                id="description"
                [error]="(description | controlError) && projSubmitInitiated"
                formControlName="description"
                placeholder="Напишите кратко о своем проекте, описав в 2-3 предложениях его суть"
              ></app-textarea>
              @if ((description | controlError: "required") && projSubmitInitiated) {
              <div class="text-body-14 error">
                {{ errorMessage.VALIDATION_REQUIRED }}
              </div>
              }
            </fieldset>
            }
          </div>
        </div>

        <div class="project__right">
          @if (programTagsOptions.length) {
          <fieldset>
            <label for="program_tag" class="field-label">Выбор тега</label>
            <app-select
              id="program_tag"
              [options]="programTagsOptions"
              placeholder="Выберите программу, в которой участвуете"
              formControlName="partnerProgramId"
            ></app-select>
          </fieldset>
          } @if (projectForm.get("presentationAddress"); as presentationAddress) {
          <fieldset class="project__file">
            <app-upload-file
              formControlName="presentationAddress"
              accept=".pdf,.pptx"
              [error]="presentationAddress | controlError"
            >
              <ng-container emptyPlaceholder>
                <i appIcon icon="upload" appSquare="60"></i>
                <h4 class="text-bold-body-16 project__slides-title">
                  Добавьте&nbsp;
                  <span class="project__slides-open-file">файл</span>&nbsp; презентации
                </h4>
                <p class="text-body-14 project__slides-text">
                  Презентации формата .PDF или .PPTX весом до 50МБ
                </p>
                @if (presentationAddress | controlError: "required") {
                <p class="project__slides-error text-body-14">Загрузите файл</p>
                }
              </ng-container>
            </app-upload-file>
          </fieldset>
          } @if (projectForm.get("coverImageAddress"); as coverImageAddress) {
          <fieldset class="project__file">
            <app-upload-file
              formControlName="coverImageAddress"
              accept=".jpg,.png,.jpeg"
              [error]="coverImageAddress | controlError"
            >
              <ng-container emptyPlaceholder>
                <i appIcon icon="upload" appSquare="60"></i>
                <h4 class="text-bold-body-16 project__slides-title">
                  Добавьте&nbsp;
                  <span class="project__slides-open-file">обложку</span>&nbsp; проекта
                </h4>
                <p class="text-body-14 project__slides-text">
                  Презентации формата .jpg, .jpeg, .png
                </p>
                <p class="text-body-14 project__slides-text">Размер изображения 1280 x 230</p>
                @if (coverImageAddress | controlError: "required") {
                <p class="project__slides-error text-body-14">Загрузите файл</p>
                }
              </ng-container>
            </app-upload-file>
          </fieldset>
          }
        </div>

        } @else if (editingStep === "contacts") {
        <fieldset class="project__left">
          <label class="field-label">Ссылка на проект</label>
          <ul formArrayName="links">
            @for (control of links.controls; let i = $index; track i) {
            <li class="edit-link">
              <app-input
                class="edit-link__input"
                [formControlName]="i"
                placeholder="https://example.com"
              ></app-input>
              <div class="edit-link__remove">
                <i appIcon icon="plus" appSquare="20"></i>
              </div>
            </li>
            }
          </ul>
        </fieldset>

        <div class="project__left">
          <app-button (click)="addLink()" class="project__add-link">
            Добавить еще одну ссылку
            <i appIcon icon="plus" appSquare="12"></i>
          </app-button>
        </div>
        } @else if (editingStep === "achievements") {
        <div class="project__left">
          <ng-container formArrayName="achievements">
            <ul id="achievements" class="project__achievements-list">
              @for (_ of achievements.controls; let i = $index; track i) {
              <li class="project__achievement-item">
                <form [formGroupName]="i" class="achievement">
                  <div class="achievement__first-row">
                    @if (achievements.at(i)?.get("title"); as title) {
                    <fieldset>
                      <label class="field-label">Ссылка на проект</label>
                      <app-input
                        [error]="
                          !!(
                            (title | controlError) &&
                            achievements.at(i).get('title')?.touched &&
                            projSubmitInitiated
                          )
                        "
                        placeholder="Напишите название мероприятия, конкурса и т.д."
                        formControlName="title"
                      ></app-input>
                      @if ( !!( (title | controlError: "required") &&
                      achievements.at(i).get("title")?.touched && projSubmitInitiated ) ) {
                      <div class="text-body-14 error">
                        {{ errorMessage.VALIDATION_REQUIRED }}
                      </div>
                      }
                    </fieldset>
                    }
                    <!-- <app-button
                      class="achievement__remove"
                      color="red"
                      (click)="removeAchievement(i)"
                    >
                      <i appIcon icon="basket" appSquare="24"></i>
                    </app-button> -->
                  </div>
                  @if (achievements.at(i).get("status"); as status) {
                  <fieldset>
                    <app-input
                      [error]="
                        !!(
                          (status | controlError) &&
                          achievements.at(i).get('status')?.touched &&
                          projSubmitInitiated
                        )
                      "
                      placeholder="Опишите достижение(победитель, призер или другое)"
                      formControlName="status"
                    ></app-input>
                    @if ( !!( (status | controlError: "required") &&
                    achievements.at(i).get("status")?.touched && projSubmitInitiated ) ) {
                    <div class="text-body-14 error">
                      {{ errorMessage.VALIDATION_REQUIRED }}
                    </div>
                    }
                  </fieldset>
                  }
                </form>
              </li>
              }
            </ul>
          </ng-container>
        </div>
        <div class="project__left">
          <app-button class="project__add-achievement" (click)="addAchievement()">
            <span>Добавить достижение</span>
            <i appIcon icon="plus" appSquare="14"></i>
          </app-button>
        </div>
        } @else if (editingStep === "team") {
        <div class="project__left">
          <h2 class="text-body-14">Приглашение участников</h2>
          <form [formGroup]="inviteForm">
            @if (inviteForm.get("role"); as role) {
            <fieldset class="invite__role">
              <app-input
                id="invite_role"
                formControlName="role"
                [error]="(role | controlError) && inviteSubmitInitiated"
                placeholder="Напишите роль участника в команде"
              ></app-input>
              @if ((role | controlError: "required") && inviteSubmitInitiated) {
              <div class="text-body-14 error">
                {{ errorMessage.VALIDATION_REQUIRED }}
              </div>
              }
            </fieldset>
            } @if (inviteForm.get("link"); as link) {
            <fieldset class="invite__link">
              <app-input
                id="invite_link"
                formControlName="link"
                [error]="(link | controlError) && inviteSubmitInitiated"
                placeholder="Вставьте ссылку на участника на платформе procollab"
              ></app-input>
              @if ((link | controlError: "required") && inviteSubmitInitiated) {
              <div class="text-body-14 error">
                {{ errorMessage.VALIDATION_REQUIRED }}
              </div>
              } @if ((link | controlError: "pattern") && inviteSubmitInitiated) {
              <div class="text-body-14 error">
                {{ errorMessage.VALIDATION_PROFILE_LINK }}
              </div>
              } @if (inviteNotExistingError && inviteSubmitInitiated) {
              <div class="text-body-14 error">
                {{ errorMessage.USER_NOT_EXISTING }}
              </div>
              }
            </fieldset>
            }
          </form>
        </div>

        <div class="project__left">
          <app-button
            class="invite__submit"
            (click)="submitInvite()"
            [loader]="inviteFormIsSubmitting"
          >
            <span>Пригласить участника</span>
            <i appIcon icon="plus" appSquare="14"></i>
          </app-button>

          <ul class="invite__list">
            @for (user of invites; track user.id) {
            <li class="invite__item">
              <app-invite-card
                [invite]="user"
                (remove)="removeInvitation($event)"
              ></app-invite-card>
            </li>
            }
          </ul>
        </div>
        } @else if (editingStep === "vacancies"){
        <div class="vacancy project__left">
          <h2 class="text-body-14 vacancy__title">Создание вакансии</h2>
          <form [formGroup]="vacancyForm">
            @if (vacancyForm.get("role"); as role) {
            <fieldset class="vacancy__role">
              <app-input
                id="vacancy_role"
                formControlName="role"
                [error]="(role | controlError) && vacancySubmitInitiated"
                placeholder="Напишите роль, которую вы хотите закрыть в вашем проекте"
              ></app-input>
              @if ((role | controlError: "required") && vacancySubmitInitiated) {
              <div class="text-body-14 error">
                {{ errorMessage.VALIDATION_REQUIRED }}
              </div>
              }
            </fieldset>
            } @if (vacancyForm.get("description"); as description) {
            <fieldset class="vacancy__description">
              <label for="description" class="field-label">Навыки</label>
              <app-textarea
                id="vacancy_description"
                formControlName="description"
                [error]="(description | controlError) && vacancySubmitInitiated"
                placeholder="Опишите вакансию"
              ></app-textarea>
              @if ((description | controlError: "required") && vacancySubmitInitiated) {
              <div class="text-body-14 error">
                {{ errorMessage.VALIDATION_REQUIRED }}
              </div>
              }
            </fieldset>
            }

            <div class="vacancy__work">
              <div class="vacancy__info">
                @if (vacancyForm.get("experience"); as experience) {
                <fieldset>
                  <app-select
                    id="experience"
                    formControlName="experience"
                    placeholder="Опыт"
                    [options]="experienceList"
                  ></app-select>
                  @if (experience | controlError: "required") {
                  <div class="text-body-14 error">
                    {{ errorMessage.VALIDATION_REQUIRED }}
                  </div>
                  }
                </fieldset>
                } @if (vacancyForm.get("format"); as format) {
                <fieldset>
                  <app-select
                    id="format"
                    formControlName="format"
                    placeholder="Формат"
                    [options]="formatList"
                  ></app-select>
                  @if (format | controlError: "required") {
                  <div class="text-body-14 error">
                    {{ errorMessage.VALIDATION_REQUIRED }}
                  </div>
                  }
                </fieldset>
                }
              </div>

              <div class="vacancy__additional">
                @if (vacancyForm.get("salary"); as salary) {
                <fieldset>
                  <app-input
                    id="salary"
                    formControlName="salary"
                    [error]="(salary | controlError) && projSubmitInitiated"
                    placeholder="Заработная плата"
                  ></app-input>
                  @if ((salary | controlError: "required") && projSubmitInitiated) {
                  <div class="text-body-14 error">
                    {{ errorMessage.VALIDATION_REQUIRED }}
                  </div>
                  }
                </fieldset>
                } @if (vacancyForm.get("schelude"); as schelude) {
                <fieldset>
                  <app-select
                    id="schelude"
                    formControlName="schelude"
                    placeholder="График"
                    [options]="formatList"
                  ></app-select>
                  @if (schelude | controlError: "required") {
                  <div class="text-body-14 error">
                    {{ errorMessage.VALIDATION_REQUIRED }}
                  </div>
                  }
                </fieldset>
                }
              </div>
            </div>

            <fieldset class="vacancy__search">
              <div class="vacancies">
                <app-autocomplete-input
                  class="vacancies__input"
                  placeholder="Введите необходимый для соискателя навык"
                  searchIcon=""
                  [suggestions]="inlineSkills()"
                  fieldToDisplay="name"
                  [forceSelect]="true"
                  [clearInputOnSelect]="true"
                  (searchStart)="onSearchSkill($event)"
                  (optionSelected)="onAddSkill($event)"
                ></app-autocomplete-input>
                <app-button
                  type="button"
                  class="vacancies__button"
                  (click)="toggleSkillsGroupsModal()"
                >
                  <i appIcon icon="folder" appWidth="24" appHeight="24"></i>
                </app-button>
              </div>
            </fieldset>

            @if (vacancyForm.get("skills"); as skills) {
            <fieldset class="skills-basket">
              <app-skills-basket
                formControlName="skills"
                [error]="skills | controlError"
              ></app-skills-basket>
              @if (skills | controlError: "required") {
              <div class="text-body-14 error">
                {{ errorMessage.VALIDATION_REQUIRED }}
              </div>
              }
            </fieldset>
            }
          </form>
        </div>

        <div class="project__left">
          <app-button
            class="vacancy__submit"
            [loader]="vacancyIsSubmitting"
            (click)="submitVacancy()"
          >
            <span>Создать вакансию</span>
            <i appIcon icon="person" appSquare="24"></i>
          </app-button>

          <ul class="vacancy__list">
            @for (vacancy of vacancies; track vacancy.id) {
            <li class="vacancy__item">
              <app-vacancy-card
                [vacancy]="vacancy"
                (edit)="editVacancy($event)"
                (remove)="removeVacancy($event)"
              ></app-vacancy-card>
            </li>
            }
          </ul>
        </div>
        }
      </div>
      <div class="project__save">
        <app-button
          customTypographyClass="text-body-12"
          color="grey"
          [loader]="projFormIsSubmittingAsDraft"
          (click)="saveProjectAsDraft()"
        >
          Сохранить черновик
        </app-button>
        <app-button
          customTypographyClass="text-body-12"
          [loader]="projFormIsSubmittingAsPublished"
          (click)="saveProjectAsPublished()"
        >
          Сохранить
        </app-button>
      </div>
    </form>
    <app-modal [open]="projectForm.invalid && projSubmitInitiated && !warningModalSeen">
      <div class="project__warning-modal">
        <h3 class="text-bold-body-16">📢 Внимание!</h3>
        <p class="text-body-14">
          Для публикации проекта, нужно заполнить все <strong>обязательные поля</strong> (они будут
          <strong>подсвечены&nbsp;<span>красным</span></strong
          >). Если вы пока не знаете что написать, можно сохранить черновик проекта и заполнить поля
          позже :&#41;
        </p>
        <app-button (click)="closeWarningModal()">Понятно</app-button>
      </div>
    </app-modal>
  </main>
</div>

<app-modal [open]="isCompleted" (openChange)="isCompleted = !isCompleted">
  <div class="cancel">
    <div class="cancel__top">
      <i (click)="isCompleted = false" appIcon icon="cross" class="cancel__cross"></i>
      <p class="cancel__title text-bold-body-16">Проект завершен!</p>
    </div>

    <img alt="end" src="assets/images/projects/detail/end.svg" class="cancel__img" />

    <p class="text-body-14 cancel__text">
      Этот проект был успешно завершён в рамках программы {{ errorModalMessage()?.program_name }}.
      Редактирование или удаление проекта больше недоступно.
    </p>
  </div>
</app-modal>

<app-modal [open]="skillsGroupsModalOpen()" class="modal">
  <div class="modal__wrapper">
    <h4 class="text-heading-4">Библиотека навыков</h4>
    <div class="modal__content">
      <div class="modal__skills-groups">
        <ul>
          @for (skillsGroup of nestedSkills$ | async; track skillsGroup.id) {
          <li>
            <app-skills-group
              [title]="skillsGroup.name"
              [options]="skillsGroup.skills"
              [selected]="this.vacancyForm.getRawValue().skills"
              (optionToggled)="onToggleSkill($event)"
            ></app-skills-group>
          </li>
          }
        </ul>
      </div>
    </div>
    <app-button (click)="toggleSkillsGroupsModal()">Сохранить</app-button>
  </div>
</app-modal>
