<!-- @format -->

@if (program) {
<main class="project">
  <section class="program__main">
    <div class="info program__section program__info">
      <div class="info__cover">
        <img
          class="info__cover"
          [src]="
            program.coverImageAddress
              ? program.coverImageAddress
              : '/assets/images/office/profile/detail/cover.png'
          "
          alt="cover"
        />
        <app-avatar
          class="info__avatar"
          [url]="program.imageAddress"
          [hasBorder]="true"
          borderColor="dark-grey"
          [size]="123"
          (click)="onOpenDetailProgram()"
        ></app-avatar>
      </div>

      <div class="info__body">
        <div class="info__actions">
          @if (!program.isUserMember && !program.isUserManager && !registerDateExpired) { @if
          (program.name.includes("Кейс-чемпионат MIR")) {
          <a href="https://case-champ.ru/corporate#rec1176757836">
            <app-button appearance="outline" size="medium" customTypographyClass="text-body-12">
              зарегистрироваться
            </app-button>
          </a>
          } @else {
          <a [routerLink]="['/office/program', program.id, 'register']">
            <app-button appearance="outline" size="medium" customTypographyClass="text-body-12">
              зарегистрироваться
            </app-button>
          </a>
          } } @else if (program.isUserMember) {
          <app-button
            size="medium"
            (click)="toggleSubmitProjectModal()"
            customTypographyClass="text-body-12 bar__add-project"
          >
            <span class="bar__add-project-text">подать проект</span>
            <i appIcon icon="plus" appSquare="10"></i>
          </app-button>
          } @else if (program.isUserManager) {
          <a [routerLink]="'/office/program/' + program.id + '/projects-rating'">
            <app-button appearance="outline" size="medium" customTypographyClass="text-body-12">
              оценка проектов
            </app-button>
          </a>
          }

          <a
            class="info__presentation"
            [href]="program.presentationAddress"
            download=""
            target="_blank"
          >
            <app-button appearance="outline" size="medium" customTypographyClass="text-body-12">
              {{
                program.name.includes("Технолидеры Будущего")
                  ? "Каталог лучших стартапов 2022/23"
                  : "положение"
              }}
              <i appIcon class="info__presentation-icon" icon="arrow-down" appSquare="10"></i>
            </app-button>
          </a>

          <!-- TODO: внести ссылку на сайт программы когда это поле будет на бэке -->
          @if (!program.isUserManager) {
          <a class="info__more">
            <app-button
              appearance="outline"
              [disabled]="true"
              size="medium"
              customTypographyClass="text-body-12"
              >узнать подробнее</app-button
            >
          </a>
          } @else {
          <a [routerLink]="'/office/program/' + program.id + '/projects'">
            <app-button appearance="outline" size="medium" customTypographyClass="text-body-12">
              проекты-участники
            </app-button>
          </a>
          } @if (!program.isUserManager) {
          <!-- добавить информацию с ссылок или чего-то в дизайне телефон но не у каждой программы есть телефон в контактах -->
          <a class="info__contacts">
            <app-button
              [disabled]="true"
              appearance="outline"
              size="medium"
              customTypographyClass="text-body-12"
              >информация с ссылок</app-button
            >
          </a>
          } @else {
          <a [routerLink]="'/office/program/' + program.id + '/projects'">
            <app-button appearance="outline" size="medium" customTypographyClass="text-body-12">
              участники
            </app-button>
          </a>
          }
        </div>
      </div>
    </div>

    <!-- advertisementImageAddress поле только для тех кто не участник программы поэтому нельзя сделать toggle и давать появляться или нет полю -->
    @if ((!program.isUserMember || program.isUserManager) && !showDetails) {
    <div class="program__advertisement">
      <img [src]="program.advertisementImageAddress" [alt]="program.name" />
    </div>
    } @else if ((program.isUserMember && showDetails) || program.isUserManager) {
    <div class="program__details">
      <div class="program__left">
        <aside class="program__aside">
          @if (program.isUserMember) {
          <div class="program__analytics">
            <div class="analytics">
              <div class="analytics__soon">
                <div class="analytics__closed">
                  <i appIcon icon="lock" appSquare="10"></i>
                  <span class="text-body-6 analytics__closed--text">пока закрыто</span>
                </div>
                <app-button customTypographyClass="text-body-6" color="green" size="extra-small"
                  >скоро</app-button
                >
              </div>

              <div class="analytics__info">
                <p class="text-body-12">аналитика</p>
                <p class="text-body-6">
                  уровень включённости студентов, статистика достижения целей в проектах
                </p>
              </div>
            </div>
          </div>
          }
        </aside>
      </div>

      <div class="program__content">
        <div class="about program__about">
          <div class="about__head">
            <h3 class="text-body-12 about__title">о программе</h3>
            <i appIcon icon="folder" appSquare="12" class="about__head--icon"></i>
          </div>
          @if (program.description) {
          <div class="text-body-10 about__text">
            <p #descEl [innerHTML]="program.description | parseLinks | parseBreaks"></p>
            @if (descriptionExpandable) {
            <div
              class="read-more"
              (click)="onExpandDescription(descEl, 'expanded', readFullDescription)"
            >
              {{ readFullDescription ? "cкрыть" : "подробнее" }}
            </div>
            }
          </div>
          }
        </div>
        <div class="news">
          @if (program.isUserManager) {
          <app-news-form class="news__form" (addNews)="onAddNews($event)"></app-news-form>
          } @for (n of news(); track n.id) {
          <app-program-news-card
            class="news__item"
            [attr.data-id]="n.id"
            [newsItem]="n"
            [isOwner]="program.isUserMember"
            (like)="onLike($event)"
            (delete)="onDelete($event)"
          ></app-program-news-card>
          }
        </div>
      </div>

      <div class="program__right">
        <aside class="program__aside">
          @if (program.isUserMember && (program.links?.length && program.links)) {
          <div class="links program__section">
            <div class="links__section">
              <h3 class="links__title text-body-12">контакты</h3>
              <i appIcon icon="phone" class="links__icon" appSquare="12"></i>
            </div>
            <ul>
              @for (link of program.links; track $index) {
              <li class="contact-link links__item text-body-10">
                @if (link | userLinks; as l) {
                <a
                  class="contact-link__link"
                  target="_blank"
                  [href]="link.includes('@') ? 'mailto:' + link : link"
                >
                  <i class="contact-link__icon" appIcon [icon]="l.iconName" appSquare="10"></i>
                  <span>{{ l.tag }}</span>
                </a>
                }
              </li>
              }
            </ul>
          </div>
          }
        </aside>

        <aside class="program__aside">
          @if (program.isUserMember && (program.materials?.length && program.materials)) {
          <div class="links program__section">
            <div class="links__section">
              <h3 class="links__title text-body-12">материалы</h3>
              <i appIcon icon="book" appSquare="12" class="links__icon"></i>
            </div>
            <ul>
              @for (material of program.materials; track $index) {
              <li class="contact-link links__item text-body-10">
                @if (material.url | userLinks; as l) {
                <a
                  class="contact-link__link"
                  target="_blank"
                  [href]="material.url.includes('@') ? 'mailto:' + material.url : material.url"
                >
                  <i class="contact-link__icon" appIcon [icon]="l.iconName" appSquare="10"></i>
                  <span>{{ material.title }}</span>
                </a>
                }
              </li>
              }
            </ul>
          </div>
          }
        </aside>
      </div>
    </div>
    }
  </section>
</main>

<app-modal [open]="showProgramModal()" (openChange)="showProgramModal.set(!showProgramModal)">
  <div class="cancel" style="width: 500px; padding: 40px 0px 40px">
    <div class="cancel__top">
      <i appIcon icon="cross" class="cancel__cross" (click)="closeModal()"></i>
      <p class="cancel__title text-body-14">
        вы не являетесь экспертом или организатором программы!
      </p>
    </div>

    @if (showProgramModalErrorMessage()) {
    <p class="text-body-10 cancel__text">
      {{ showProgramModalErrorMessage() }}
    </p>
    }

    <app-button class="cancel__button" (click)="closeModal()" customTypographyClass="text-body-12"
      >хорошо</app-button
    >
  </div>
</app-modal>

<app-modal [open]="showSubmitProjectModal()" (openChange)="toggleSubmitProjectModal()">
  <div class="cancel">
    <div class="cancel__top">
      <p class="cancel__title text-body-14">выберите проект для подачи</p>
      <p class="cancel__text text-body-10">
        после выбора проекта будет создан дубликат данного проекта для заполнения под конкретный
        конкурс
      </p>

      <div class="project">
        <ul class="project__list" [class.project__list--scrollable]="memberProjects.length > 3">
          @for (project of memberProjects; track project.id) {
          <li class="project__item">
            <div class="project__item--info">
              <app-avatar [url]="project.imageAddress" [size]="40"></app-avatar>
              <p class="text-body-12">
                {{ project.name }}
              </p>
            </div>
            <app-input
              type="radio"
              [appValue]="project.id.toLocaleString()"
              [checked]="selectedProjectId === project.id"
              (change)="onProjectRadioChange($event)"
            ></app-input>
          </li>
          }
        </ul>
      </div>
    </div>

    <app-button
      size="medium"
      class="cancel__button"
      customTypographyClass="text-body-12"
      [disabled]="!selectedProjectId"
      (click)="addProjectModal()"
    >
      выбрать проект
    </app-button>
  </div>
</app-modal>

<app-modal
  [open]="isAssignProjectToProgramError"
  (openChange)="isAssignProjectToProgramError ? clearAssignProjectToProgramError() : null"
>
  <div class="cancel" style="padding: 24px">
    <div class="cancel__top">
      <p class="cancel__title text-body-14">ошибка привязки проекта к программе!</p>
    </div>

    <p class="text-body-10 cancel__text">
      {{ (errorAssignProjectToProgramModalMessage()?.non_field_errors)![0] }}
    </p>

    <app-button
      size="medium"
      class="cancel__button"
      customTypographyClass="text-body-12"
      (click)="clearAssignProjectToProgramError()"
      >понятно</app-button
    >
  </div>
</app-modal>

<app-modal
  [open]="isAssignProjectToProgramModalOpen()"
  (openChange)="isAssignProjectToProgramModalOpen.set(!isAssignProjectToProgramModalOpen)"
>
  <div class="cancel" style="padding: 24px">
    <div class="cancel__top">
      <p class="cancel__title text-body-14">поздравляем!</p>
    </div>

    <p class="text-body-10 cancel__text">
      мы создали дубликат проекта, который вы привязали к выбранной программе
      <span
        ><strong>{{ assignProjectToProgramModalMessage()?.partnerProgram }}</strong></span
      >, теперь его можно отредактировать!
    </p>

    <app-button
      size="medium"
      class="cancel__button"
      customTypographyClass="text-body-12"
      (click)="closeAssignProjectToProgramModal()"
      >вперед</app-button
    >
  </div>
</app-modal>
}
